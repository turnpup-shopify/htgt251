{% schema %}
{
  "name": "AT - Scrolling Products",
  "settings": [
    {
        "type": "metaobject",
        "id": "input_metaobject",
        "label": "input metaobject",
        "metaobject_type": "tp_carousel"
    }
  ],
  "presets": [
    {
      "name": "AT - Scrolling Products"
    }
  ]
}
{% endschema %}

{% stylesheet %}
<style>
  .scrolling-product-showcase {
    height: 50vh;
    position: relative;
    overflow: hidden;
    background: #f8f8f8;
  }

  .scrolling-product-list {
    height: 100%;
    overflow-y: scroll;
    padding: 2rem;
    scroll-snap-type: y mandatory;
  }

  .product-title {
    font-size: 2rem;
    margin: 3rem 0;
    text-align: center;
    scroll-snap-align: center;
    cursor: pointer;
  }

  .product-image-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-height: 60%;
    max-width: 60%;
    z-index: 2;
    pointer-events: auto;
    box-shadow: 0 0 40px rgba(0,0,0,0.25);
    transition: opacity 0.3s ease;
  }

  .product-image-overlay img {
    width: 100%;
    height: auto;
    display: block;
    cursor: pointer;
  }
</style>
{% endstylesheet %}

<script>
  function initScrollObserver(container) {
    const list = container.querySelector('.scrolling-product-list');
    const items = container.querySelectorAll('.product-title');
    const overlay = container.querySelector('.product-image-overlay');
    const overlayImg = overlay?.querySelector('img');

    console.log('[Init] Found elements:', { list, items, overlay, overlayImg });

    if (!list || !items.length || !overlayImg) {
      console.warn('[Init] Missing required elements. Aborting scroll observer init.');
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const img = entry.target.getAttribute('data-img');
            const url = entry.target.getAttribute('data-url');
            if (img) overlayImg.src = img;
            if (url) overlayImg.setAttribute('data-link', url);
            console.log('[Observer] In view:', entry.target.textContent);
          }
        });
      },
      {
        root: list,
        threshold: 0.6,
      }
    );

    items.forEach((item) => observer.observe(item));

    overlayImg.addEventListener('click', () => {
      const link = overlayImg.getAttribute('data-link');
      console.log('[Click] Navigating to:', link);
      if (link) window.location.href = link;
    });
  }

  // Initial load
  window.addEventListener('load', () => {
    const section = document.querySelector('#scrolling-product-showcase-{{ section.id }}');
    if (section) {
      console.log('[Load] Initializing scroll module for section {{ section.id }}');
      initScrollObserver(section);
    }
  });

  // When section is dynamically loaded
  document.addEventListener('shopify:section:load', (event) => {
    const section = event.target.querySelector('#scrolling-product-showcase-{{ section.id }}');
    if (section) {
      console.log('[Shopify Section Load] Re-initializing scroll module for section {{ section.id }}');
      initScrollObserver(section);
    }
  });
</script>

<div class="scrolling-product-showcase">

  {% assign metaobject_id = section.settings.input_metaobject %}
  {% assign my_metaobject = shop.metaobjects.tp_carousel[metaobject_id] %}
  {%- assign use_collection = collections[my_metaobject.collection_handle] -%}
  <script>console.log("{{use_collection.title}}");</script>

  {%  comment  %}
  {% render 'tp-prod-carousel-block'
    , input_products: use_collection.products
    , input_type: "products"
    , input_title: my_metaobject.title
    , input_shop_all_text: "shop all"
    , input_shop_all_link: use_collection.url %}
  {% endcomment %}

  {% if use_collection != blank %}
    <div class="scrolling-product-list">
      {% for product in use_collection.products %}
        <div
          class="product-title"
          data-img="{{ product.featured_image | image_url: width: 800 }}"
          data-url="{{ product.url }}">
          {{ product.title }}
        </div>
      {% endfor %}
    </div>

    <div class="product-image-overlay">
      <img src="" alt="Product Preview" />
    </div>
  {% else %}
    <p style="padding: 2rem; text-align: center;">Please select a metaobject that links to a valid collection.</p>
  {% endif %}
</div>
{% comment %}
  Section: Tabbed merch navigator (True Classic–style)
  - Add blocks for each tab. Each block has a label and a menu (link list).
  - Each tab renders inline buttons from the menu’s top-level links.
  - Clicking a button swaps the grid below with a soft fade.
  - Supported link targets: collections (renders products), products (renders single card).
{% endcomment %}

<section
  class="tc-tabs-wrapper"
  id="tc-tabs-{{ section.id }}"
  style="margin: var(--outer-mt) var(--outer-mr) var(--outer-mb) var(--outer-ml); padding: var(--outer-pt) var(--outer-pr) var(--outer-pb) var(--outer-pl);">
  {% if section.settings.heading != blank %}
    <h2 class="tc-heading">{{ section.settings.heading | escape }}</h2>
  {% endif %}

  <div
    class="tc-tablist"
    role="tablist"
    aria-label="{{ section.settings.heading | default: 'Catalog tabs' | escape }}">
    {% for block in section.blocks %}
      {% assign is_active = forloop.first %}
      <button
        class="tc-tab {% if is_active %}is-active{% endif %}"
        id="tc-tab-{{ section.id }}-{{ block.id }}"
        role="tab"
        aria-selected="{% if is_active %}true{% else %}false{% endif %}"
        aria-controls="tc-panel-{{ section.id }}-{{ block.id }}"
        data-tab-target="tc-panel-{{ section.id }}-{{ block.id }}">
        {{ block.settings.label | escape }}
      </button>
    {% endfor %}
  </div>

  {% for block in section.blocks %}
    {% assign is_active = forloop.first %}
    {% assign menu = linklists[block.settings.menu] %}
    <div
      id="tc-panel-{{ section.id }}-{{ block.id }}"
      class="tc-tabpanel {% if is_active %}is-active{% endif %}"
      role="tabpanel"
      aria-labelledby="tc-tab-{{ section.id }}-{{ block.id }}"
      {% unless is_active %}
      hidden{% endunless %}>
      {% if menu and menu.links.size > 0 %}
        <div
          class="tc-subnav"
          role="tablist"
          aria-label="{{ block.settings.label | escape }} subfilters">
          {% for l in menu.links %}
            {% assign sub_active = forloop.first %}
            <button
              class="tc-pill {% if sub_active %}is-active{% endif %}"
              role="tab"
              aria-selected="{% if sub_active %}true{% else %}false{% endif %}"
              aria-controls="tc-grid-{{ section.id }}-{{ block.id }}-{{ forloop.index }}"
              data-subgrid-target="tc-grid-{{ section.id }}-{{ block.id }}-{{ forloop.index }}">
              {{ l.title | escape }}
            </button>
          {% endfor %}
        </div>

        {% comment %} Render a grid per subfilter button {% endcomment %}
        <div class="tc-grids">
          {% for l in menu.links %}
            {% assign sub_active = forloop.first %}
            {% assign link_type = l.type %}
            <div
              id="tc-grid-{{ section.id }}-{{ block.id }}-{{ forloop.index }}"
              class="tc-grid {% if sub_active %}is-active{% endif %}"
              {% unless sub_active %}
              hidden{% endunless %}>
              {% case link_type %}
                {% when 'collection_link' %}
                  {% assign handle_from_object = l.object.handle %}
                  {% assign handle_from_url = l.url | split: '/collections/' | last | split: '?' | first %}
                  {% assign coll_handle = handle_from_object | default: handle_from_url %}
                  {% assign coll = collections[coll_handle] %}
                  {% if coll %}
                    {% for product in coll.products limit: section.settings.max_items %}
                      <a class="tc-card" href="{{ product.url }}">
                        <div class="tc-imgwrap">
                          {% assign img = product.featured_image %}
                          {% if img %}
                            <img
                              loading="lazy"
                              src="{{ img | image_url: width: 600 }}"
                              srcset="{{ img | image_url: width: 400 }} 400w, {{ img | image_url: width: 600 }} 600w, {{ img | image_url: width: 900 }} 900w"
                              sizes="(min-width: 990px) 240px, 45vw"
                              alt="{{ img.alt | escape }}">
                          {% endif %}
                        </div>
                        <div class="tc-meta">
                          <span class="tc-title">{{ product.title }}</span>
                          {% if product.price %}
                            <span class="tc-price">{{ product.price | money }}</span>
                          {% endif %}
                        </div>
                      </a>
                    {% else %}
                      <p class="tc-empty">{{ 'sections.collection_template.empty' | t }}</p>
                    {% endfor %}
                  {% endif %}

                {% when 'product_link' %}
                  {% assign p = l.object %}
                  {% if p %}
                    <a class="tc-card" href="{{ p.url }}">
                      <div class="tc-imgwrap">
                        {% if p.featured_image %}
                          <img
                            loading="lazy"
                            src="{{ p.featured_image | image_url: width: 800 }}"
                            alt="{{ p.featured_image.alt | escape }}">
                        {% endif %}
                      </div>
                      <div class="tc-meta">
                        <span class="tc-title">{{ p.title }}</span>
                        <span class="tc-price">{{ p.price | money }}</span>
                      </div>
                    </a>
                  {% endif %}

                {% else %}
                  {% comment %}
                    Fallback for generic links. If it resolves to a collection handle in URL, try to fetch it.
                  {% endcomment %}
                  {% assign handle = l.url | split: '/collections/' | last | split: '?' | first %}
                  {% assign fallback_coll = collections[handle] %}
                  {% if fallback_coll %}
                    {% for product in fallback_coll.products limit: section.settings.max_items %}
                      <a class="tc-card" href="{{ product.url }}">
                        <div class="tc-imgwrap">
                          {% if product.featured_image %}
                            <img
                              loading="lazy"
                              src="{{ product.featured_image | image_url: width: 600 }}"
                              alt="{{ product.featured_image.alt | escape }}">
                          {% endif %}
                        </div>
                        <div class="tc-meta">
                          <span class="tc-title">{{ product.title }}</span>
                          <span class="tc-price">{{ product.price | money }}</span>
                        </div>
                      </a>
                    {% endfor %}
                  {% else %}
                    <a class="tc-card tc-linkonly" href="{{ l.url }}">{{ l.title | escape }}</a>
                  {% endif %}
              {% endcase %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="tc-empty">Assign a menu to this tab.</p>
      {% endif %}
    </div>
  {% endfor %}
</section>

<style>
  #tc-tabs-{{ section.id }} {
    --col-gap: {{ section.settings.grid_col_gap | default: 16 }}px;
    --row-gap: {{ section.settings.grid_row_gap | default: 20 }}px;
    --pill-gap: 10px;
    --fade-ms: 220ms;
    --outer-mt: {{ section.settings.margin_top | default: 0 }}px;
    --outer-mr: {{ section.settings.margin_right | default: 0 }}px;
    --outer-mb: {{ section.settings.margin_bottom | default: 0 }}px;
    --outer-ml: {{ section.settings.margin_left | default: 0 }}px;
    --outer-pt: {{ section.settings.padding_top | default: 0 }}px;
    --outer-pr: {{ section.settings.padding_right | default: 0 }}px;
    --outer-pb: {{ section.settings.padding_bottom | default: 0 }}px;
    --outer-pl: {{ section.settings.padding_left | default: 0 }}px;
    --img-radius: {{ section.settings.img_radius | default: 12 }}px;
    --cols-mobile: {{ section.settings.cols_mobile | default: 2 }};
    --cols-desktop: {{ section.settings.cols_desktop | default: 4 }};
    --title-fs: {{ section.settings.title_font_size_desktop | default: 14 }}px;
    --title-fs-m: {{ section.settings.title_font_size_mobile | default: 14 }}px;
    --title-fw: {{ section.settings.title_font_weight | default: 600 }};
    --title-ff: {{ section.settings.title_font_family | default: 'Helvetica Neue' }};
    --price-fs: {{ section.settings.price_font_size_desktop | default: 14 }}px;
    --price-fs-m: {{ section.settings.price_font_size_mobile | default: 14 }}px;
    --price-fw: {{ section.settings.price_font_weight | default: 600 }};
    --price-ff: {{ section.settings.price_font_family | default: 'Helvetica Neue' }};
    --heading-ff: {{ section.settings.heading_font_family | default: 'Helvetica Neue' }};
    --heading-fw: {{ section.settings.heading_font_weight | default: 700 }};
    --heading-fs: {{ section.settings.heading_font_size_desktop | default: 28 }}px;
    --heading-fs-m: {{ section.settings.heading_font_size_mobile | default: 22 }}px;
  }
  @media(max-width: 700px) {
    #tc-tabs-{{ section.id }} {
      --outer-mt: {{ section.settings.m_margin_top | default: section.settings.margin_top | default: 0 }}px;
      --outer-mr: {{ section.settings.m_margin_right | default: section.settings.margin_right | default: 0 }}px;
      --outer-mb: {{ section.settings.m_margin_bottom | default: section.settings.margin_bottom | default: 0 }}px;
      --outer-ml: {{ section.settings.m_margin_left | default: section.settings.margin_left | default: 0 }}px;
      --outer-pt: {{ section.settings.m_padding_top | default: section.settings.padding_top | default: 0 }}px;
      --outer-pr: {{ section.settings.m_padding_right | default: section.settings.padding_right | default: 0 }}px;
      --outer-pb: {{ section.settings.m_padding_bottom | default: section.settings.padding_bottom | default: 0 }}px;
      --outer-pl: {{ section.settings.m_padding_left | default: section.settings.padding_left | default: 0 }}px;
    }
  }
  #tc-tabs-{{ section.id }}
  .tc-heading {
    margin-bottom: 14px;
    font-family: var(--heading-ff)
    , system-ui
    , -apple-system
    , Segoe UI
    , Roboto
    , Arial
    , sans-serif;
    font-weight: var(--heading-fw);
    font-size: var(--heading-fs);
    line-height: 1.2;
  }
  @media(max-width: 700px) {
    #tc-tabs-{{ section.id }} .tc-heading {
      font-size: var(--heading-fs-m);
    }
  }
  #tc-tabs-{{ section.id }}
  .tc-tablist {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 6px;
  }
  #tc-tabs-{{ section.id }}
  .tc-tab {
    appearance: none;
    border: 0;
    background: transparent;
    color: #555;
    padding: 8px 2px;
    border-radius: 0;
    cursor: pointer;
    font-weight: 600;
    border-bottom: 2px solid transparent;
  }
  #tc-tabs-{{ section.id }}
  .tc-tab.is-active {
    color: #111;
    border-bottom-color: #111;
    background: transparent;
  }
  #tc-tabs-{{ section.id }}.tc-tab:hover {
    color: #111;
  }
  #tc-tabs-{{ section.id }}
  .tc-subnav {
    display: flex;
    gap: 8px;
    margin: 6px 0 16px;
    flex-wrap: wrap;
  }
  #tc-tabs-{{ section.id }}
  .tc-pill {
    appearance: none;
    border: 1px solid #e0e0e0;
    background: #fff;
    color: #444;
    padding: 6px 10px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 500;
  }
  #tc-tabs-{{ section.id }}
  .tc-pill.is-active {
    background: #f3f3f3;
    border-color: #111;
    color: #111;
  }
  #tc-tabs-{{ section.id }}.tc-pill:hover {
    border-color: #bbb;
    color: #111;
  }
  #tc-tabs-{{ section.id }}
  .tc-tabpanel {
    opacity: 0;
    transition: opacity var(--fade-ms) ease;
  }
  #tc-tabs-{{ section.id }}
  .tc-tabpanel.is-active {
    opacity: 1;
  }
  #tc-tabs-{{ section.id }}
  .tc-grids {
    position: relative;
  }
  #tc-tabs-{{ section.id }}
  .tc-grid {
    display: grid;
    grid-template-columns: repeat(var(--cols-mobile), 1fr);
    column-gap: var(--col-gap);
    row-gap: var(--row-gap);
    opacity: 0;
    transition: opacity var(--fade-ms) ease;
  }
  @media(min-width: 990px) {
    #tc-tabs-{{ section.id }} .tc-grid {
      grid-template-columns: repeat(var(--cols-desktop), 1fr);
    }
  }
  #tc-tabs-{{ section.id }}
  .tc-grid.is-active {
    opacity: 1;
  }
  #tc-tabs-{{ section.id }}
  .tc-card {
    display: block;
    text-decoration: none;
    color: inherit;
  }
  #tc-tabs-{{ section.id }}
  .tc-imgwrap {
    aspect-ratio: 1 / 1;
    background: #f7f7f7;
    overflow: hidden;
    border-radius: var(--img-radius);
  }
  #tc-tabs-{{ section.id }}
  .tc-imgwrap img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 200ms ease;
  }
  #tc-tabs-{{ section.id }}.tc-card:hover .tc-imgwrap img {
    transform: scale(1.03);
  }
  #tc-tabs-{{ section.id }}
  .tc-meta {
    margin-top: 8px;
    display: block;
  }
  #tc-tabs-{{ section.id }}
  .tc-title {
    display: block;
    font-size: var(--title-fs);
    font-weight: var(--title-fw);
    font-family: var(--title-ff)
    , system-ui
    , -apple-system
    , Segoe UI
    , Roboto
    , Arial
    , sans-serif;
    line-height: 1.3;
  }
  @media(max-width: 700px) {
    #tc-tabs-{{ section.id }} .tc-title {
      font-size: var(--title-fs-m);
    }
  }
  #tc-tabs-{{ section.id }}
  .tc-price {
    display: block;
    margin-top: 4px;
    font-size: var(--price-fs);
    font-weight: var(--price-fw);
    font-family: var(--price-ff)
    , system-ui
    , -apple-system
    , Segoe UI
    , Roboto
    , Arial
    , sans-serif;
  }
  @media(max-width: 700px) {
    #tc-tabs-{{ section.id }} .tc-price {
      font-size: var(--price-fs-m);
    }
  }
  #tc-tabs-{{ section.id }}
  .tc-empty {
    color: #666;
    font-size: 14px;
  }
  #tc-tabs-{{ section.id }}
  [hidden] {
    display: none !important;
  }
</style>

<script>
  (function() {
    const root = document.getElementById('tc-tabs-{{ section.id }}');
    if (!root) return;

    // Tabs
    const tabs = root.querySelectorAll('.tc-tab');
    const panels = root.querySelectorAll('.tc-tabpanel');

    function activateTab(btn) {
      tabs.forEach(t => { t.classList.remove('is-active'); t.setAttribute('aria-selected','false'); });
      panels.forEach(p => { p.classList.remove('is-active'); p.hidden = true; });
      btn.classList.add('is-active'); btn.setAttribute('aria-selected','true');
      const id = btn.dataset.tabTarget;
      const panel = root.querySelector('#' + id);
      if (panel) { panel.hidden = false; requestAnimationFrame(() => panel.classList.add('is-active')); }
    }

    tabs.forEach(btn => btn.addEventListener('click', () => activateTab(btn)));

    // Subfilters within each tab
    panels.forEach(panel => {
      const pills = panel.querySelectorAll('.tc-pill');
      const grids = panel.querySelectorAll('.tc-grid');
      function activatePill(p) {
        pills.forEach(el => { el.classList.remove('is-active'); el.setAttribute('aria-selected','false'); });
        grids.forEach(g => { g.classList.remove('is-active'); g.hidden = true; });
        p.classList.add('is-active'); p.setAttribute('aria-selected','true');
        const id = p.dataset.subgridTarget;
        const grid = panel.querySelector('#' + id);
        if (grid) { grid.hidden = false; requestAnimationFrame(() => grid.classList.add('is-active')); }
      }
      pills.forEach(p => p.addEventListener('click', () => activatePill(p)));
    });
  })();
</script>

{% schema %}
  {
    "name": "Tabbed merch navigator",
    "settings": [
      {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "Shop"
      },
      {
        "type": "range",
        "id": "max_items",
        "label": "Max products per grid",
        "min": 4,
        "max": 24,
        "step": 1,
        "default": 8
      },
      {
        "type": "header",
        "content": "Outer spacing"
      },
      {
        "type": "range",
        "id": "margin_top",
        "label": "Margin top",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "margin_right",
        "label": "Margin right",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "margin_bottom",
        "label": "Margin bottom",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "margin_left",
        "label": "Margin left",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "padding_top",
        "label": "Padding top",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "padding_right",
        "label": "Padding right",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "padding_bottom",
        "label": "Padding bottom",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "padding_left",
        "label": "Padding left",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "img_radius",
        "label": "Image border radius (px)",
        "min": 0,
        "max": 48,
        "step": 1,
        "default": 12
      }, {
        "type": "header",
        "content": "Mobile spacing (≤700px)"
      }, {
        "type": "range",
        "id": "m_margin_top",
        "label": "Mobile margin top",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "m_margin_right",
        "label": "Mobile margin right",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "m_margin_bottom",
        "label": "Mobile margin bottom",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "m_margin_left",
        "label": "Mobile margin left",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "m_padding_top",
        "label": "Mobile padding top",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "m_padding_right",
        "label": "Mobile padding right",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "m_padding_bottom",
        "label": "Mobile padding bottom",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "range",
        "id": "m_padding_left",
        "label": "Mobile padding left",
        "min": 0,
        "max": 160,
        "step": 4,
        "default": 0
      }, {
        "type": "header",
        "content": "Grid columns"
      }, {
        "type": "range",
        "id": "cols_mobile",
        "label": "Columns on mobile",
        "min": 1,
        "max": 3,
        "step": 1,
        "default": 2
      }, {
        "type": "range",
        "id": "cols_desktop",
        "label": "Columns on desktop",
        "min": 3,
        "max": 5,
        "step": 1,
        "default": 4
      }, {
        "type": "header",
        "content": "Typography"
      }, {
        "type": "range",
        "id": "title_font_size_desktop",
        "label": "Title font size desktop (px)",
        "min": 10,
        "max": 36,
        "step": 1,
        "default": 14
      }, {
        "type": "range",
        "id": "title_font_size_mobile",
        "label": "Title font size mobile (px)",
        "min": 10,
        "max": 36,
        "step": 1,
        "default": 14
      }, {
        "type": "select",
        "id": "title_font_weight",
        "label": "Title font weight",
        "options": [
          {
            "label": "300",
            "value": "300"
          },
          {
            "label": "400",
            "value": "400"
          },
          {
            "label": "500",
            "value": "500"
          },
          {
            "label": "600",
            "value": "600"
          }, {
            "label": "700",
            "value": "700"
          }, {
            "label": "800",
            "value": "800"
          }
        ],
        "default": "600"
      }, {
        "type": "text",
        "id": "title_font_family",
        "label": "Title font family",
        "default": "Helvetica Neue"
      }, {
        "type": "range",
        "id": "price_font_size_desktop",
        "label": "Price font size desktop (px)",
        "min": 10,
        "max": 36,
        "step": 1,
        "default": 14
      }, {
        "type": "range",
        "id": "price_font_size_mobile",
        "label": "Price font size mobile (px)",
        "min": 10,
        "max": 36,
        "step": 1,
        "default": 14
      }, {
        "type": "select",
        "id": "price_font_weight",
        "label": "Price font weight",
        "options": [
          {
            "label": "300",
            "value": "300"
          },
          {
            "label": "400",
            "value": "400"
          },
          {
            "label": "500",
            "value": "500"
          },
          {
            "label": "600",
            "value": "600"
          }, {
            "label": "700",
            "value": "700"
          }, {
            "label": "800",
            "value": "800"
          }
        ],
        "default": "600"
      }, {
        "type": "text",
        "id": "price_font_family",
        "label": "Price font family",
        "default": "Helvetica Neue"
      }, {
        "type": "header",
        "content": "Module header"
      }, {
        "type": "text",
        "id": "heading_font_family",
        "label": "Header font family",
        "default": "Helvetica Neue"
      }, {
        "type": "select",
        "id": "heading_font_weight",
        "label": "Header font weight",
        "options": [
          {
            "label": "300",
            "value": "300"
          },
          {
            "label": "400",
            "value": "400"
          },
          {
            "label": "500",
            "value": "500"
          },
          {
            "label": "600",
            "value": "600"
          }, {
            "label": "700",
            "value": "700"
          }, {
            "label": "800",
            "value": "800"
          }
        ],
        "default": "700"
      }, {
        "type": "range",
        "id": "heading_font_size_desktop",
        "label": "Header font size desktop (px)",
        "min": 12,
        "max": 64,
        "step": 1,
        "default": 28
      }, {
        "type": "range",
        "id": "heading_font_size_mobile",
        "label": "Header font size mobile (px)",
        "min": 12,
        "max": 48,
        "step": 1,
        "default": 22
      }, {
        "type": "header",
        "content": "Layout spacing"
      }, {
        "type": "range",
        "id": "grid_col_gap",
        "label": "Grid column gap (px)",
        "min": 0,
        "max": 48,
        "step": 1,
        "default": 16
      }, {
        "type": "range",
        "id": "grid_row_gap",
        "label": "Grid row gap (px)",
        "min": 0,
        "max": 48,
        "step": 1,
        "default": 24
      }
    ],
    "blocks": [
      {
        "type": "tab",
        "name": "Tab",
        "settings": [
          {
            "type": "text",
            "id": "label",
            "label": "Tab label",
            "default": "Bestsellers"
          }, {
            "type": "link_list",
            "id": "menu",
            "label": "Menu for subfilters",
            "default": "main-menu"
          }
        ]
      }
    ],
    "max_blocks": 8,
    "presets": [
      {
        "name": "Tabbed merch navigator",
        "category": "Merchandising"
      }
    ]
  }
{% endschema %}